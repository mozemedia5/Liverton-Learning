rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== HELPER FUNCTIONS ====================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get the current user's ID
    function currentUserId() {
      return request.auth.uid;
    }
    
    // Get the current user's data
    function currentUserData() {
      return get(/databases/$(database)/documents/users/$(currentUserId())).data;
    }
    
    // Check if user is platform admin
    function isPlatformAdmin() {
      return isAuthenticated() && currentUserData().role == 'platform_admin';
    }
    
    // Check if user is school admin
    function isSchoolAdmin() {
      return isAuthenticated() && currentUserData().role == 'school_admin';
    }
    
    // Check if user is teacher
    function isTeacher() {
      return isAuthenticated() && currentUserData().role == 'teacher';
    }
    
    // Check if user is parent
    function isParent() {
      return isAuthenticated() && currentUserData().role == 'parent';
    }
    
    // Check if user is student
    function isStudent() {
      return isAuthenticated() && currentUserData().role == 'student';
    }
    
    // Get current user's school ID
    function currentUserSchoolId() {
      return currentUserData().schoolId;
    }
    
    // ==================== USERS COLLECTION ====================
    
    match /users/{userId} {
      // Platform admins can read ALL users
      allow read: if isPlatformAdmin();
      
      // Platform admins can write (update/delete) any user
      allow write: if isPlatformAdmin();
      
      // Users can read and write their own data
      allow read, write: if isAuthenticated() && currentUserId() == userId;
      
      // School admins can read teachers and students in their school
      allow read: if isSchoolAdmin() && 
        (resource.data.schoolId == currentUserSchoolId() || 
         resource.data.role == 'teacher' && resource.data.schoolId == currentUserSchoolId() ||
         resource.data.role == 'student' && resource.data.schoolId == currentUserSchoolId());
      
      // Teachers can read students in their school
      allow read: if isTeacher() && 
        resource.data.role == 'student' && 
        resource.data.schoolId == currentUserSchoolId();
      
      // Teachers can read other teachers in their school
      allow read: if isTeacher() && 
        resource.data.role == 'teacher' && 
        resource.data.schoolId == currentUserSchoolId();
      
      // Parents can read their linked children's data
      allow read: if isParent() && 
        resource.data.role == 'student' && 
        currentUserData().linkedStudentIds != null &&
        userId in currentUserData().linkedStudentIds;
      
      // Allow create during registration (user creating their own document)
      allow create: if isAuthenticated() && currentUserId() == userId;
    }
    
    // ==================== SCHOOLS COLLECTION ====================
    
    match /schools/{schoolId} {
      // Platform admins can do everything
      allow read, write: if isPlatformAdmin();
      
      // Anyone can read school info
      allow read: if isAuthenticated();
      
      // School admins can update their own school
      allow write: if isSchoolAdmin() && 
        currentUserData().schoolId == schoolId;
    }
    
    // ==================== COURSES COLLECTION ====================
    
    match /courses/{courseId} {
      // Platform admins can do everything
      allow read, write: if isPlatformAdmin();
      
      // School admins can read all courses in their school
      allow read: if isSchoolAdmin() && 
        resource.data.schoolId == currentUserSchoolId();
      
      // School admins can create courses for their school
      allow create: if isSchoolAdmin() && 
        request.resource.data.schoolId == currentUserSchoolId();
      
      // Teachers can read courses they created or in their school
      allow read: if isTeacher() && 
        (resource.data.teacherId == currentUserId() || 
         resource.data.schoolId == currentUserSchoolId());
      
      // Teachers can create courses
      allow create: if isTeacher();
      
      // Teachers can update their own courses
      allow update: if isTeacher() && 
        resource.data.teacherId == currentUserId();
      
      // Students can read courses they're enrolled in
      allow read: if isStudent() && 
        currentUserId() in resource.data.enrolledStudents;
      
      // Parents can read courses their children are enrolled in
      allow read: if isParent();
    }
    
    // ==================== ANNOUNCEMENTS ====================
    
    match /announcements/{announcementId} {
      // Platform admins can do everything
      allow read, write: if isPlatformAdmin();
      
      // School admins can create announcements for their school
      allow create: if isSchoolAdmin() && 
        (request.resource.data.targetSchoolId == currentUserSchoolId() ||
         request.resource.data.targetSchoolId == null);
      
      // School admins can read announcements for their school
      allow read: if isSchoolAdmin() && 
        (resource.data.targetSchoolId == currentUserSchoolId() ||
         resource.data.targetSchoolId == null);
      
      // Everyone can read announcements
      allow read: if isAuthenticated();
      
      // Only platform and school admins can write
      allow write: if isPlatformAdmin() || isSchoolAdmin();
    }
    
    // ==================== CHATS ====================
    
    match /chats/{chatId} {
      // Platform admins can read all chats
      allow read: if isPlatformAdmin();
      
      // Users can read chats they're participants in
      allow read: if isAuthenticated() && 
        currentUserId() in resource.data.participants;
      
      // Users can create chats
      allow create: if isAuthenticated();
      
      // Users can update chats they're in
      allow update: if isAuthenticated() && 
        currentUserId() in resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
          currentUserId() in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow create: if isAuthenticated();
      }
    }
    
    // ==================== DOCUMENTS ====================
    
    match /documents/{documentId} {
      // Platform admins can do everything
      allow read, write: if isPlatformAdmin();
      
      // Users can read documents they own
      allow read: if isAuthenticated() && 
        resource.data.ownerId == currentUserId();
      
      // Users can read documents shared with them
      allow read: if isAuthenticated() && 
        currentUserId() in resource.data.sharedWith;
      
      // Users can create their own documents
      allow create: if isAuthenticated() && 
        request.resource.data.ownerId == currentUserId();
      
      // Users can update their own documents
      allow update: if isAuthenticated() && 
        resource.data.ownerId == currentUserId();
      
      // Users can delete their own documents
      allow delete: if isAuthenticated() && 
        resource.data.ownerId == currentUserId();
    }
    
    // ==================== QUIZZES ====================
    
    match /quizzes/{quizId} {
      // Platform admins can do everything
      allow read, write: if isPlatformAdmin();
      
      // Teachers can read and write quizzes for their courses
      allow read, write: if isTeacher();
      
      // Students can read quizzes for their enrolled courses
      allow read: if isStudent();
      
      // Parents can read quizzes
      allow read: if isParent();
      
      // School admins can read quizzes in their school
      allow read: if isSchoolAdmin();
    }
    
    // ==================== ATTENDANCE ====================
    
    match /attendance/{recordId} {
      // Platform admins can do everything
      allow read, write: if isPlatformAdmin();
      
      // School admins can read and write attendance for their school
      allow read, write: if isSchoolAdmin() && 
        resource.data.schoolId == currentUserSchoolId();
      
      // Teachers can read and write attendance for their school
      allow read, write: if isTeacher() && 
        resource.data.schoolId == currentUserSchoolId();
      
      // Students can read their own attendance
      allow read: if isStudent() && 
        resource.data.studentId == currentUserId();
      
      // Parents can read their children's attendance
      allow read: if isParent();
    }
    
    // ==================== PAYMENTS ====================
    
    match /payments/{paymentId} {
      // Platform admins can do everything
      allow read, write: if isPlatformAdmin();
      
      // Users can read their own payments
      allow read: if isAuthenticated() && 
        resource.data.userId == currentUserId();
      
      // Users can create payments for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.userId == currentUserId();
      
      // School admins can read payments for their school
      allow read: if isSchoolAdmin();
    }
    
    // ==================== HANNA AI CHATS ====================
    
    match /hannaChats/{chatId} {
      // Platform admins can read all
      allow read: if isPlatformAdmin();
      
      // Users can read their own chats
      allow read, write: if isAuthenticated() && 
        resource.data.userId == currentUserId();
      
      allow create: if isAuthenticated() && 
        request.resource.data.userId == currentUserId();
      
      match /messages/{messageId} {
        allow read, write: if isAuthenticated() && 
          get(/databases/$(database)/documents/hannaChats/$(chatId)).data.userId == currentUserId();
        allow create: if isAuthenticated();
      }
    }
    
    // ==================== DEFAULT RULE ====================
    
    match /{document=**} {
      // Platform admins can access everything
      allow read, write: if isPlatformAdmin();
      
      // Authenticated users can read by default
      allow read: if isAuthenticated();
      
      // Authenticated users can write by default (for collections not specified above)
      allow write: if isAuthenticated();
    }
  }
}
